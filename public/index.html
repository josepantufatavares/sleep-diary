<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Digital Sleep Diary</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.5.0/Recharts.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0f172a; color: #fff; font-family: system-ui, sans-serif; min-height: 100vh; }
  input, select, textarea, button { font-family: inherit; }
  input[type=range] { width: 100%; cursor: pointer; }
  input[type=range].accent-indigo { accent-color: #6366f1; }
  input[type=range].accent-yellow { accent-color: #fbbf24; }
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: #1e293b; }
  ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
  .inp { width:100%; background:#1e293b; border:1px solid #475569; border-radius:8px; padding:10px 12px; color:#fff; font-size:1rem; outline:none; }
  .inp:focus { border-color:#818cf8; }
  .sel { width:100%; background:#1e293b; border:1px solid #475569; border-radius:8px; padding:10px 12px; color:#fff; font-size:1rem; outline:none; }
  .lbl { display:block; color:#e2e8f0; font-size:0.9rem; margin-bottom:5px; font-weight:500; }
  .btn-primary { width:100%; padding:12px; border-radius:12px; font-weight:700; color:#fff; border:none; cursor:pointer; font-size:1rem; background:linear-gradient(to right,#4f46e5,#7c3aed); transition:opacity 0.15s; }
  .btn-primary:hover { opacity:0.9; }
  .btn-outline { background:none; border:1px solid #64748b; color:#cbd5e1; border-radius:8px; padding:6px 14px; font-size:0.85rem; cursor:pointer; transition:color 0.15s; }
  .btn-outline:hover { color:#fff; border-color:#94a3b8; }
  .tab-btn { flex-shrink:0; padding:12px 16px; font-size:0.9rem; font-weight:600; background:none; border:none; border-bottom:2px solid transparent; cursor:pointer; color:#94a3b8; transition:color 0.15s; }
  .tab-btn.active { color:#a5b4fc; border-bottom-color:#6366f1; }
  .card { background:#1e293b; border:1px solid #334155; border-radius:12px; padding:16px; }
  .stat-card { background:#1e293b; border:1px solid #334155; border-radius:12px; padding:16px; text-align:center; }
  .mini-card { background:#334155; border-radius:8px; padding:10px 6px; text-align:center; }
  .space-y-2>*+* { margin-top:8px; }
  .space-y-3>*+* { margin-top:12px; }
  .space-y-4>*+* { margin-top:16px; }
  .space-y-5>*+* { margin-top:20px; }
  .grad-header { background:linear-gradient(to right,#1e1b4b,#4c1d95,#0f172a); }
  .grad-admin  { background:linear-gradient(to right,#4a1d96,#1e1b4b,#0f172a); }
  .spinner { border:3px solid #334155; border-top-color:#6366f1; border-radius:50%; width:32px; height:32px; animation:spin 0.7s linear infinite; margin:40px auto; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .footer { text-align:center; padding:10px 16px; color:#64748b; font-size:0.78rem; border-top:1px solid #1e293b; margin-top:12px; }

  /* Language Selector */
  .lang-selector { position:relative; }
  .lang-btn {
    display:flex; align-items:center; gap:6px;
    background:rgba(30,41,59,0.95); border:1px solid #475569;
    border-radius:8px; padding:6px 10px; color:#cbd5e1;
    font-size:0.82rem; font-weight:600; cursor:pointer;
    backdrop-filter:blur(8px); transition:border-color 0.15s, color 0.15s;
    white-space:nowrap;
  }
  .lang-btn:hover { border-color:#818cf8; color:#fff; }
  .lang-flag { font-size:1rem; line-height:1; }
  .lang-caret { font-size:0.6rem; opacity:0.6; margin-left:1px; }
  .lang-dropdown {
    position:absolute; top:calc(100% + 6px); right:0;
    background:#1e293b; border:1px solid #334155; border-radius:10px;
    min-width:168px; overflow:hidden;
    box-shadow:0 8px 28px rgba(0,0,0,0.5);
    animation:ldFade 0.12s ease;
    z-index:200;
  }
  @keyframes ldFade { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:none; } }
  .lang-option {
    display:flex; align-items:center; gap:10px;
    padding:9px 14px; font-size:0.88rem; color:#cbd5e1;
    cursor:pointer; transition:background 0.1s, color 0.1s;
    border:none; background:none; width:100%; text-align:left;
  }
  .lang-option:hover { background:#334155; color:#fff; }
  .lang-option.selected { color:#a5b4fc; background:rgba(99,102,241,0.14); font-weight:600; }
  .lo-flag { font-size:1.1rem; }
</style>
</head>
<body>
<div id="root"></div>
<script>
const { useState, useEffect, useCallback, useRef } = React;
const { BarChart, Bar, LineChart, Line, RadarChart, Radar, PolarGrid, PolarAngleAxis,
        XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

/* â”€â”€ i18n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LANGUAGES = [
  { code:"en", label:"English",   flag:"ðŸ‡¬ðŸ‡§" },
  { code:"hr", label:"Hrvatski",  flag:"ðŸ‡­ðŸ‡·" },
  { code:"es", label:"EspaÃ±ol",   flag:"ðŸ‡ªðŸ‡¸" },
  { code:"pt", label:"PortuguÃªs", flag:"ðŸ‡µðŸ‡¹" },
  { code:"tr", label:"TÃ¼rkÃ§e",    flag:"ðŸ‡¹ðŸ‡·" },
];

const T = {
  en:{
    appTitle:"Digital Sleep Diary",appSubtitle:"Track sleep Â· screen time Â· morning energy",
    login:"Login",register:"Register",username:"Username",password:"Password",
    confirmPassword:"Confirm Password",securityQuestion:"Security Question",yourAnswer:"Your Answer",
    loginBtn:"Login â†’",createAccountBtn:"Create Account â†’",forgotPassword:"Forgot password?",
    passwordRecovery:"Password Recovery",newPassword:"New Password",confirmNewPassword:"Confirm New Password",
    currentPassword:"Current Password",saveChanges:"Save Changes",resetPassword:"Reset Password",
    next:"Next â†’",loading:"Loading...",saving:"Saving...",resetting:"Resetting...",
    logout:"Logout",changePw:"ðŸ”‘ Password",
    fillAllFields:"Please fill all fields.",passwordsDontMatch:"Passwords don't match.",
    provideSecAnswer:"Please provide a security answer.",enterUsername:"Enter your username.",
    enterAnswer:"Please enter your answer.",minChars:"Min. 4 characters.",
    passwordChanged:"Password changed!",passwordReset:"Password reset!",
    passwordResetLogin:"Password reset! You can now log in.",
    tabLog:"ðŸ“ Log",tabHistory:"ðŸ“… History",tabCharts:"ðŸ“Š Charts",tabInsights:"ðŸ’¡ Insights",tabTips:"ðŸŒ¿ Tips",
    tabOverview:"ðŸ“Š Overview",tabRankings:"ðŸ† Rankings",tabCompare:"ðŸ‘¥ Compare",tabStudents:"ðŸ“‹ Students",
    todayLog:"Today's Sleep Log",date:"ðŸ“… Date",bedtime:"ðŸ›ï¸ Bedtime",wakeUp:"â° Wake-up",
    duration:"Duration: ",screenTime:"ðŸ“± Pre-sleep screen time: ",morningEnergy:"âš¡ Morning energy: ",
    notes:"ðŸ“ Notes",notesPlaceholder:"How did you sleep?",saveEntry:"ðŸ’¾ Save Entry",saved:"âœ… Saved!",
    weeklyHistory:"Weekly History",noEntries:"No entries yet. Start logging! ðŸŒ™",
    sleep:"Sleep",screen:"Screen",energy:"Energy",
    weeklyCharts:"Weekly Charts",log2days:"Log at least 2 days! ðŸ“Š",
    sleepDuration:"Sleep Duration (hours)",screenVsEnergy:"Screen Time vs Energy",
    autoInsights:"Automatic Insights",log2insights:"Log at least 2 days to get personalized insights!",
    sleepHygiene:"Sleep Hygiene Tips",adminPanel:"ðŸ›¡ï¸ Admin Panel",studentsReg:" students registered",
    groupOverview:"Group Overview",noStudentData:"No student data yet.",
    avgSleep:"Avg Sleep",avgEnergy:"Avg Energy",avgScreen:"Avg Screen",totalLogs:"Total Logs",
    studentAverages:"Student Averages",sleepPerStudent:"Sleep per Student",energyVsScreen:"Energy vs Screen",
    radarProfiles:"Radar â€” Student Profiles",rankings:"ðŸ† Rankings",noData:"No data yet.",
    mostSleep:"Most Sleep ðŸ˜´",bestEnergy:"Best Energy âš¡",leastScreen:"Least Screen ðŸ“µ",mostConsistent:"Most Consistent ðŸ“…",
    collectiveCharts:"ðŸ‘¥ Collective Charts",need2students:"Need at least 2 students with data.",
    allStudents:"ðŸ“‹ All Students",noStudents:"No students registered yet.",noEntriesYet:"No entries yet.",
    hAvg:"h avg",avg10:"/10 avg",logs:"logs",resetBtn:"ðŸ”‘ Reset",
    iB7a:"âš ï¸ Your average sleep is ",iB7b:"h â€” below the recommended 7â€“9 hours.",
    iA7a:"âœ… Great! Your average sleep of ",iA7b:"h is within healthy range.",
    iSca:"ðŸ’¡ On days with â‰¤1h screen time, your energy was ",iScb:" pts higher!",
    iHSa:"ðŸ“± You average ",iHSb:"h of pre-sleep screen time. Try reducing it.",
    iHEa:"âš¡ Morning energy is strong (avg ",iHEb:"/10). Keep it up!",
    iLEa:"ðŸ˜´ Morning energy is low (avg ",iLEb:"/10). Better habits may help.",
    secQ0:"What was the name of your first pet?",secQ1:"What is your mother's maiden name?",
    secQ2:"What city were you born in?",secQ3:"What was the name of your primary school?",
    secQ4:"What is your favourite book?",
    t0t:"Limit Screen Time",t0d:"Avoid screens at least 1 hour before bed. Blue light suppresses melatonin production.",
    t1t:"Consistent Schedule",t1d:"Go to bed and wake up at the same time every day, even on weekends.",
    t2t:"Cool Your Room",t2d:"Keep your bedroom between 16â€“20Â°C for optimal sleep quality.",
    t3t:"Avoid Caffeine",t3d:"Avoid caffeine after 2 PM. It can stay in your system for up to 6 hours.",
    t4t:"Wind Down",t4d:"Try reading, stretching, or meditation before bed to signal your brain it's time to sleep.",
    t5t:"Darkness Matters",t5d:"Use blackout curtains or a sleep mask. Even small amounts of light can disrupt sleep.",
    answerHint:"Answer (case insensitive)",usernamePh:"your username",developed:"Desenvolvido por: JosÃ© Paulo Tavares",
  },
  hr:{
    appTitle:"Digitalni Dnevnik Sna",appSubtitle:"Pratite san Â· vrijeme zaslona Â· jutarnju energiju",
    login:"Prijava",register:"Registracija",username:"KorisniÄko ime",password:"Lozinka",
    confirmPassword:"Potvrdi lozinku",securityQuestion:"Sigurnosno pitanje",yourAnswer:"VaÅ¡ odgovor",
    loginBtn:"Prijava â†’",createAccountBtn:"Stvori raÄun â†’",forgotPassword:"Zaboravili ste lozinku?",
    passwordRecovery:"Oporavak lozinke",newPassword:"Nova lozinka",confirmNewPassword:"Potvrdi novu lozinku",
    currentPassword:"Trenutna lozinka",saveChanges:"Spremi promjene",resetPassword:"Resetiraj lozinku",
    next:"Dalje â†’",loading:"UÄitavanje...",saving:"Spremanje...",resetting:"Resetiranje...",
    logout:"Odjava",changePw:"ðŸ”‘ Lozinka",
    fillAllFields:"Molimo ispunite sva polja.",passwordsDontMatch:"Lozinke se ne podudaraju.",
    provideSecAnswer:"Molimo unesite sigurnosni odgovor.",enterUsername:"Unesite korisniÄko ime.",
    enterAnswer:"Molimo unesite odgovor.",minChars:"Min. 4 znaka.",
    passwordChanged:"Lozinka promijenjena!",passwordReset:"Lozinka resetirana!",
    passwordResetLogin:"Lozinka resetirana! Sada se moÅ¾ete prijaviti.",
    tabLog:"ðŸ“ Unos",tabHistory:"ðŸ“… Povijest",tabCharts:"ðŸ“Š Grafovi",tabInsights:"ðŸ’¡ Uvidi",tabTips:"ðŸŒ¿ Savjeti",
    tabOverview:"ðŸ“Š Pregled",tabRankings:"ðŸ† Rang lista",tabCompare:"ðŸ‘¥ Usporedi",tabStudents:"ðŸ“‹ Studenti",
    todayLog:"DanaÅ¡nji unos sna",date:"ðŸ“… Datum",bedtime:"ðŸ›ï¸ Odlazak na spavanje",wakeUp:"â° BuÄ‘enje",
    duration:"Trajanje: ",screenTime:"ðŸ“± Vrijeme zaslona prije sna: ",morningEnergy:"âš¡ Jutarnja energija: ",
    notes:"ðŸ“ BiljeÅ¡ke",notesPlaceholder:"Kako ste spavali?",saveEntry:"ðŸ’¾ Spremi unos",saved:"âœ… Spremljeno!",
    weeklyHistory:"Tjedna povijest",noEntries:"Nema unosa. PoÄnite biljeÅ¾iti! ðŸŒ™",
    sleep:"San",screen:"Zaslon",energy:"Energija",
    weeklyCharts:"Tjedni grafovi",log2days:"Unesite najmanje 2 dana! ðŸ“Š",
    sleepDuration:"Trajanje sna (sati)",screenVsEnergy:"Zaslon vs Energija",
    autoInsights:"Automatski uvidi",log2insights:"Unesite najmanje 2 dana za personalizirane uvide!",
    sleepHygiene:"Savjeti za higijenu sna",adminPanel:"ðŸ›¡ï¸ Admin panel",studentsReg:" studenata registrirano",
    groupOverview:"Grupni pregled",noStudentData:"Nema podataka o studentima.",
    avgSleep:"Prosj. san",avgEnergy:"Prosj. energija",avgScreen:"Prosj. zaslon",totalLogs:"Ukupno unosa",
    studentAverages:"Prosjeci studenata",sleepPerStudent:"San po studentu",energyVsScreen:"Energija vs Zaslon",
    radarProfiles:"Radar â€” Profili studenata",rankings:"ðŸ† Rang lista",noData:"Nema podataka.",
    mostSleep:"NajviÅ¡e sna ðŸ˜´",bestEnergy:"Najbolja energija âš¡",leastScreen:"Najmanje zaslona ðŸ“µ",mostConsistent:"Najdosljedniji ðŸ“…",
    collectiveCharts:"ðŸ‘¥ Skupni grafovi",need2students:"Potrebna su najmanje 2 studenta s podacima.",
    allStudents:"ðŸ“‹ Svi studenti",noStudents:"Nema registriranih studenata.",noEntriesYet:"Nema unosa.",
    hAvg:"h prosjek",avg10:"/10 prosjek",logs:"unosa",resetBtn:"ðŸ”‘ Reset",
    iB7a:"âš ï¸ VaÅ¡ prosjeÄni san je ",iB7b:"h â€” ispod preporuÄenih 7â€“9 sati.",
    iA7a:"âœ… OdliÄno! VaÅ¡ prosjeÄni san od ",iA7b:"h je unutar zdravog raspona.",
    iSca:"ðŸ’¡ Dana s â‰¤1h zaslona, vaÅ¡a energija bila je ",iScb:" boda viÅ¡a!",
    iHSa:"ðŸ“± Prosjek vam je ",iHSb:"h zaslona prije sna. PokuÅ¡ajte smanjiti.",
    iHEa:"âš¡ Jutarnja energija je jaka (prosjek ",iHEb:"/10). Nastavite tako!",
    iLEa:"ðŸ˜´ Jutarnja energija je niska (prosjek ",iLEb:"/10). Bolje navike mogu pomoÄ‡i.",
    secQ0:"Kako se zvao vaÅ¡ prvi ljubimac?",secQ1:"Koje je djevojaÄko prezime vaÅ¡e majke?",
    secQ2:"U kojemu gradu ste roÄ‘eni?",secQ3:"Kako se zvala vaÅ¡a osnovna Å¡kola?",secQ4:"Koja je vaÅ¡a omiljena knjiga?",
    t0t:"OgraniÄite ekrane",t0d:"Izbjegavajte zaslone barem 1 sat prije spavanja. Plavo svjetlo smanjuje melatonin.",
    t1t:"Dosljedan raspored",t1d:"Idite spavati i budite se u isto vrijeme svaki dan, ukljuÄujuÄ‡i vikende.",
    t2t:"Rashladite sobu",t2d:"OdrÅ¾avajte temperaturu spavaÄ‡e sobe izmeÄ‘u 16â€“20Â°C za optimalan san.",
    t3t:"Izbjegavajte kofein",t3d:"Izbjegavajte kofein nakon 14h. MoÅ¾e ostati u organizmu do 6 sati.",
    t4t:"Opustite se",t4d:"PokuÅ¡ajte Äitati, istezati se ili meditirati prije spavanja.",
    t5t:"Tama je vaÅ¾na",t5d:"Koristite zamraÄujuÄ‡e zavjese ili masku za spavanje. ÄŒak i mala koliÄina svjetla moÅ¾e poremetiti san.",
    answerHint:"Odgovor (nije osjetljivo na veliÄinu slova)",usernamePh:"vaÅ¡e korisniÄko ime",developed:"Desenvolvido por: JosÃ© Paulo Tavares",
  },
  es:{
    appTitle:"Diario Digital del SueÃ±o",appSubtitle:"Registra sueÃ±o Â· tiempo de pantalla Â· energÃ­a matutina",
    login:"Iniciar sesiÃ³n",register:"Registrarse",username:"Usuario",password:"ContraseÃ±a",
    confirmPassword:"Confirmar contraseÃ±a",securityQuestion:"Pregunta de seguridad",yourAnswer:"Tu respuesta",
    loginBtn:"Iniciar sesiÃ³n â†’",createAccountBtn:"Crear cuenta â†’",forgotPassword:"Â¿Olvidaste tu contraseÃ±a?",
    passwordRecovery:"Recuperar contraseÃ±a",newPassword:"Nueva contraseÃ±a",confirmNewPassword:"Confirmar nueva contraseÃ±a",
    currentPassword:"ContraseÃ±a actual",saveChanges:"Guardar cambios",resetPassword:"Restablecer contraseÃ±a",
    next:"Siguiente â†’",loading:"Cargando...",saving:"Guardando...",resetting:"Restableciendo...",
    logout:"Cerrar sesiÃ³n",changePw:"ðŸ”‘ ContraseÃ±a",
    fillAllFields:"Por favor, rellena todos los campos.",passwordsDontMatch:"Las contraseÃ±as no coinciden.",
    provideSecAnswer:"Por favor, proporciona una respuesta de seguridad.",enterUsername:"Introduce tu nombre de usuario.",
    enterAnswer:"Por favor, introduce tu respuesta.",minChars:"MÃ­n. 4 caracteres.",
    passwordChanged:"Â¡ContraseÃ±a cambiada!",passwordReset:"Â¡ContraseÃ±a restablecida!",
    passwordResetLogin:"Â¡ContraseÃ±a restablecida! Ya puedes iniciar sesiÃ³n.",
    tabLog:"ðŸ“ Registro",tabHistory:"ðŸ“… Historial",tabCharts:"ðŸ“Š GrÃ¡ficos",tabInsights:"ðŸ’¡ AnÃ¡lisis",tabTips:"ðŸŒ¿ Consejos",
    tabOverview:"ðŸ“Š Resumen",tabRankings:"ðŸ† ClasificaciÃ³n",tabCompare:"ðŸ‘¥ Comparar",tabStudents:"ðŸ“‹ Alumnos",
    todayLog:"Registro de sueÃ±o de hoy",date:"ðŸ“… Fecha",bedtime:"ðŸ›ï¸ Hora de dormir",wakeUp:"â° Despertar",
    duration:"DuraciÃ³n: ",screenTime:"ðŸ“± Tiempo de pantalla antes de dormir: ",morningEnergy:"âš¡ EnergÃ­a matutina: ",
    notes:"ðŸ“ Notas",notesPlaceholder:"Â¿CÃ³mo dormiste?",saveEntry:"ðŸ’¾ Guardar registro",saved:"âœ… Â¡Guardado!",
    weeklyHistory:"Historial semanal",noEntries:"Sin registros. Â¡Comienza a anotar! ðŸŒ™",
    sleep:"SueÃ±o",screen:"Pantalla",energy:"EnergÃ­a",
    weeklyCharts:"GrÃ¡ficos semanales",log2days:"Â¡Registra al menos 2 dÃ­as! ðŸ“Š",
    sleepDuration:"DuraciÃ³n del sueÃ±o (horas)",screenVsEnergy:"Pantalla vs EnergÃ­a",
    autoInsights:"AnÃ¡lisis automÃ¡tico",log2insights:"Â¡Registra al menos 2 dÃ­as para anÃ¡lisis personalizados!",
    sleepHygiene:"Consejos de higiene del sueÃ±o",adminPanel:"ðŸ›¡ï¸ Panel de administraciÃ³n",studentsReg:" alumnos registrados",
    groupOverview:"Resumen del grupo",noStudentData:"Sin datos de alumnos.",
    avgSleep:"SueÃ±o medio",avgEnergy:"EnergÃ­a media",avgScreen:"Pantalla media",totalLogs:"Total registros",
    studentAverages:"Promedios de alumnos",sleepPerStudent:"SueÃ±o por alumno",energyVsScreen:"EnergÃ­a vs Pantalla",
    radarProfiles:"Radar â€” Perfiles de alumnos",rankings:"ðŸ† ClasificaciÃ³n",noData:"Sin datos.",
    mostSleep:"MÃ¡s sueÃ±o ðŸ˜´",bestEnergy:"Mejor energÃ­a âš¡",leastScreen:"Menos pantalla ðŸ“µ",mostConsistent:"MÃ¡s constante ðŸ“…",
    collectiveCharts:"ðŸ‘¥ GrÃ¡ficos colectivos",need2students:"Se necesitan al menos 2 alumnos con datos.",
    allStudents:"ðŸ“‹ Todos los alumnos",noStudents:"No hay alumnos registrados.",noEntriesYet:"Sin registros.",
    hAvg:"h prom.",avg10:"/10 prom.",logs:"registros",resetBtn:"ðŸ”‘ Resetear",
    iB7a:"âš ï¸ Tu sueÃ±o promedio es ",iB7b:"h â€” por debajo de las 7â€“9 horas recomendadas.",
    iA7a:"âœ… Â¡Genial! Tu sueÃ±o promedio de ",iA7b:"h estÃ¡ dentro del rango saludable.",
    iSca:"ðŸ’¡ En dÃ­as con â‰¤1h de pantalla, tu energÃ­a fue ",iScb:" pts mÃ¡s alta!",
    iHSa:"ðŸ“± Promedias ",iHSb:"h de pantalla antes de dormir. Intenta reducirlo.",
    iHEa:"âš¡ La energÃ­a matutina es alta (prom. ",iHEb:"/10). Â¡Sigue asÃ­!",
    iLEa:"ðŸ˜´ La energÃ­a matutina es baja (prom. ",iLEb:"/10). Mejores hÃ¡bitos pueden ayudar.",
    secQ0:"Â¿CÃ³mo se llamaba tu primera mascota?",secQ1:"Â¿CuÃ¡l es el apellido de soltera de tu madre?",
    secQ2:"Â¿En quÃ© ciudad naciste?",secQ3:"Â¿CÃ³mo se llamaba tu escuela primaria?",secQ4:"Â¿CuÃ¡l es tu libro favorito?",
    t0t:"Limita el tiempo de pantalla",t0d:"Evita las pantallas al menos 1 hora antes de dormir. La luz azul suprime la melatonina.",
    t1t:"Horario constante",t1d:"AcuÃ©state y levÃ¡ntate a la misma hora todos los dÃ­as, incluso los fines de semana.",
    t2t:"EnfrÃ­a tu habitaciÃ³n",t2d:"MantÃ©n tu dormitorio entre 16â€“20Â°C para una calidad de sueÃ±o Ã³ptima.",
    t3t:"Evita la cafeÃ­na",t3d:"Evita la cafeÃ­na despuÃ©s de las 14h. Puede permanecer en tu sistema hasta 6 horas.",
    t4t:"DesconÃ©ctate",t4d:"Prueba leer, estirarte o meditar antes de dormir.",
    t5t:"La oscuridad importa",t5d:"Usa cortinas opacas o antifaz. Incluso pequeÃ±as cantidades de luz pueden alterar el sueÃ±o.",
    answerHint:"Respuesta (sin distinciÃ³n de mayÃºsculas)",usernamePh:"tu nombre de usuario",developed:"Desenvolvido por: JosÃ© Paulo Tavares",
  },
  pt:{
    appTitle:"DiÃ¡rio Digital do Sono",appSubtitle:"Registe o sono Â· tempo de ecrÃ£ Â· energia matinal",
    login:"Entrar",register:"Registar",username:"Nome de utilizador",password:"Palavra-passe",
    confirmPassword:"Confirmar palavra-passe",securityQuestion:"Pergunta de seguranÃ§a",yourAnswer:"A sua resposta",
    loginBtn:"Entrar â†’",createAccountBtn:"Criar conta â†’",forgotPassword:"Esqueceu a palavra-passe?",
    passwordRecovery:"RecuperaÃ§Ã£o de palavra-passe",newPassword:"Nova palavra-passe",confirmNewPassword:"Confirmar nova palavra-passe",
    currentPassword:"Palavra-passe atual",saveChanges:"Guardar alteraÃ§Ãµes",resetPassword:"Repor palavra-passe",
    next:"Seguinte â†’",loading:"A carregar...",saving:"A guardar...",resetting:"A repor...",
    logout:"Terminar sessÃ£o",changePw:"ðŸ”‘ Palavra-passe",
    fillAllFields:"Por favor, preencha todos os campos.",passwordsDontMatch:"As palavras-passe nÃ£o coincidem.",
    provideSecAnswer:"Por favor, forneÃ§a uma resposta de seguranÃ§a.",enterUsername:"Introduza o nome de utilizador.",
    enterAnswer:"Por favor, introduza a sua resposta.",minChars:"MÃ­n. 4 caracteres.",
    passwordChanged:"Palavra-passe alterada!",passwordReset:"Palavra-passe reposta!",
    passwordResetLogin:"Palavra-passe reposta! Pode agora iniciar sessÃ£o.",
    tabLog:"ðŸ“ Registo",tabHistory:"ðŸ“… HistÃ³rico",tabCharts:"ðŸ“Š GrÃ¡ficos",tabInsights:"ðŸ’¡ AnÃ¡lise",tabTips:"ðŸŒ¿ Dicas",
    tabOverview:"ðŸ“Š VisÃ£o Geral",tabRankings:"ðŸ† ClassificaÃ§Ã£o",tabCompare:"ðŸ‘¥ Comparar",tabStudents:"ðŸ“‹ Alunos",
    todayLog:"Registo de sono de hoje",date:"ðŸ“… Data",bedtime:"ðŸ›ï¸ Hora de deitar",wakeUp:"â° Hora de acordar",
    duration:"DuraÃ§Ã£o: ",screenTime:"ðŸ“± Tempo de ecrÃ£ antes de dormir: ",morningEnergy:"âš¡ Energia matinal: ",
    notes:"ðŸ“ Notas",notesPlaceholder:"Como dormiu?",saveEntry:"ðŸ’¾ Guardar registo",saved:"âœ… Guardado!",
    weeklyHistory:"HistÃ³rico semanal",noEntries:"Sem registos. Comece a registar! ðŸŒ™",
    sleep:"Sono",screen:"EcrÃ£",energy:"Energia",
    weeklyCharts:"GrÃ¡ficos semanais",log2days:"Registe pelo menos 2 dias! ðŸ“Š",
    sleepDuration:"DuraÃ§Ã£o do sono (horas)",screenVsEnergy:"EcrÃ£ vs Energia",
    autoInsights:"AnÃ¡lise automÃ¡tica",log2insights:"Registe pelo menos 2 dias para anÃ¡lises personalizadas!",
    sleepHygiene:"Dicas de higiene do sono",adminPanel:"ðŸ›¡ï¸ Painel de administraÃ§Ã£o",studentsReg:" alunos registados",
    groupOverview:"VisÃ£o geral do grupo",noStudentData:"Sem dados de alunos.",
    avgSleep:"Sono mÃ©dio",avgEnergy:"Energia mÃ©dia",avgScreen:"EcrÃ£ mÃ©dio",totalLogs:"Total de registos",
    studentAverages:"MÃ©dias dos alunos",sleepPerStudent:"Sono por aluno",energyVsScreen:"Energia vs EcrÃ£",
    radarProfiles:"Radar â€” Perfis dos alunos",rankings:"ðŸ† ClassificaÃ§Ã£o",noData:"Sem dados.",
    mostSleep:"Mais sono ðŸ˜´",bestEnergy:"Melhor energia âš¡",leastScreen:"Menos ecrÃ£ ðŸ“µ",mostConsistent:"Mais consistente ðŸ“…",
    collectiveCharts:"ðŸ‘¥ GrÃ¡ficos coletivos",need2students:"SÃ£o necessÃ¡rios pelo menos 2 alunos com dados.",
    allStudents:"ðŸ“‹ Todos os alunos",noStudents:"Nenhum aluno registado.",noEntriesYet:"Sem registos.",
    hAvg:"h mÃ©dia",avg10:"/10 mÃ©dia",logs:"registos",resetBtn:"ðŸ”‘ Repor",
    iB7a:"âš ï¸ O seu sono mÃ©dio Ã© ",iB7b:"h â€” abaixo das 7â€“9 horas recomendadas.",
    iA7a:"âœ… Excelente! O seu sono mÃ©dio de ",iA7b:"h estÃ¡ dentro do intervalo saudÃ¡vel.",
    iSca:"ðŸ’¡ Nos dias com â‰¤1h de ecrÃ£, a sua energia foi ",iScb:" pts mais alta!",
    iHSa:"ðŸ“± Em mÃ©dia, tem ",iHSb:"h de ecrÃ£ antes de dormir. Tente reduzir.",
    iHEa:"âš¡ A energia matinal Ã© boa (mÃ©dia ",iHEb:"/10). Continue assim!",
    iLEa:"ðŸ˜´ A energia matinal Ã© baixa (mÃ©dia ",iLEb:"/10). Melhores hÃ¡bitos podem ajudar.",
    secQ0:"Como se chamava o seu primeiro animal de estimaÃ§Ã£o?",secQ1:"Qual Ã© o apelido de solteira da sua mÃ£e?",
    secQ2:"Em que cidade nasceu?",secQ3:"Como se chamava a sua escola primÃ¡ria?",secQ4:"Qual Ã© o seu livro preferido?",
    t0t:"Limite o tempo de ecrÃ£",t0d:"Evite ecrÃ£s pelo menos 1 hora antes de dormir. A luz azul suprime a produÃ§Ã£o de melatonina.",
    t1t:"HorÃ¡rio consistente",t1d:"Deite-se e acorde Ã  mesma hora todos os dias, incluindo fins de semana.",
    t2t:"ArrefeÃ§a o quarto",t2d:"Mantenha o quarto entre 16â€“20Â°C para uma qualidade de sono ideal.",
    t3t:"Evite a cafeÃ­na",t3d:"Evite cafeÃ­na apÃ³s as 14h. Pode permanecer no organismo atÃ© 6 horas.",
    t4t:"Desacelere",t4d:"Tente ler, fazer alongamentos ou meditar antes de dormir para preparar o cÃ©rebro para descansar.",
    t5t:"A escuridÃ£o importa",t5d:"Use cortinas blackout ou mÃ¡scara de dormir. Mesmo pequenas quantidades de luz podem perturbar o sono.",
    answerHint:"Resposta (nÃ£o sensÃ­vel a maiÃºsculas)",usernamePh:"o seu nome de utilizador",developed:"Desenvolvido por: JosÃ© Paulo Tavares",
  },
  tr:{
    appTitle:"Dijital Uyku GÃ¼nlÃ¼ÄŸÃ¼",appSubtitle:"Uyku Â· ekran sÃ¼resi Â· sabah enerjisi takibi",
    login:"GiriÅŸ yap",register:"KayÄ±t ol",username:"KullanÄ±cÄ± adÄ±",password:"Åžifre",
    confirmPassword:"Åžifreyi onayla",securityQuestion:"GÃ¼venlik sorusu",yourAnswer:"CevabÄ±nÄ±z",
    loginBtn:"GiriÅŸ yap â†’",createAccountBtn:"Hesap oluÅŸtur â†’",forgotPassword:"Åžifremi unuttum?",
    passwordRecovery:"Åžifre kurtarma",newPassword:"Yeni ÅŸifre",confirmNewPassword:"Yeni ÅŸifreyi onayla",
    currentPassword:"Mevcut ÅŸifre",saveChanges:"DeÄŸiÅŸiklikleri kaydet",resetPassword:"Åžifreyi sÄ±fÄ±rla",
    next:"Ä°leri â†’",loading:"YÃ¼kleniyor...",saving:"Kaydediliyor...",resetting:"SÄ±fÄ±rlanÄ±yor...",
    logout:"Ã‡Ä±kÄ±ÅŸ yap",changePw:"ðŸ”‘ Åžifre",
    fillAllFields:"LÃ¼tfen tÃ¼m alanlarÄ± doldurun.",passwordsDontMatch:"Åžifreler eÅŸleÅŸmiyor.",
    provideSecAnswer:"LÃ¼tfen bir gÃ¼venlik cevabÄ± girin.",enterUsername:"KullanÄ±cÄ± adÄ±nÄ±zÄ± girin.",
    enterAnswer:"LÃ¼tfen cevabÄ±nÄ±zÄ± girin.",minChars:"En az 4 karakter.",
    passwordChanged:"Åžifre deÄŸiÅŸtirildi!",passwordReset:"Åžifre sÄ±fÄ±rlandÄ±!",
    passwordResetLogin:"Åžifre sÄ±fÄ±rlandÄ±! ArtÄ±k giriÅŸ yapabilirsiniz.",
    tabLog:"ðŸ“ KayÄ±t",tabHistory:"ðŸ“… GeÃ§miÅŸ",tabCharts:"ðŸ“Š Grafikler",tabInsights:"ðŸ’¡ Analizler",tabTips:"ðŸŒ¿ Ä°puÃ§larÄ±",
    tabOverview:"ðŸ“Š Genel BakÄ±ÅŸ",tabRankings:"ðŸ† SÄ±ralama",tabCompare:"ðŸ‘¥ KarÅŸÄ±laÅŸtÄ±r",tabStudents:"ðŸ“‹ Ã–ÄŸrenciler",
    todayLog:"BugÃ¼nÃ¼n uyku kaydÄ±",date:"ðŸ“… Tarih",bedtime:"ðŸ›ï¸ YatÄ±ÅŸ saati",wakeUp:"â° UyanÄ±ÅŸ saati",
    duration:"SÃ¼re: ",screenTime:"ðŸ“± Uyku Ã¶ncesi ekran sÃ¼resi: ",morningEnergy:"âš¡ Sabah enerjisi: ",
    notes:"ðŸ“ Notlar",notesPlaceholder:"NasÄ±l uyudunuz?",saveEntry:"ðŸ’¾ KaydÄ± kaydet",saved:"âœ… Kaydedildi!",
    weeklyHistory:"HaftalÄ±k geÃ§miÅŸ",noEntries:"KayÄ±t yok. Kaydetmeye baÅŸlayÄ±n! ðŸŒ™",
    sleep:"Uyku",screen:"Ekran",energy:"Enerji",
    weeklyCharts:"HaftalÄ±k grafikler",log2days:"En az 2 gÃ¼n kaydedin! ðŸ“Š",
    sleepDuration:"Uyku sÃ¼resi (saat)",screenVsEnergy:"Ekran vs Enerji",
    autoInsights:"Otomatik analizler",log2insights:"KiÅŸiselleÅŸtirilmiÅŸ analizler iÃ§in en az 2 gÃ¼n kaydedin!",
    sleepHygiene:"Uyku hijyeni ipuÃ§larÄ±",adminPanel:"ðŸ›¡ï¸ YÃ¶netici paneli",studentsReg:" Ã¶ÄŸrenci kayÄ±tlÄ±",
    groupOverview:"Grup genel bakÄ±ÅŸÄ±",noStudentData:"HenÃ¼z Ã¶ÄŸrenci verisi yok.",
    avgSleep:"Ort. uyku",avgEnergy:"Ort. enerji",avgScreen:"Ort. ekran",totalLogs:"Toplam kayÄ±t",
    studentAverages:"Ã–ÄŸrenci ortalamalarÄ±",sleepPerStudent:"Ã–ÄŸrenci baÅŸÄ±na uyku",energyVsScreen:"Enerji vs Ekran",
    radarProfiles:"Radar â€” Ã–ÄŸrenci profilleri",rankings:"ðŸ† SÄ±ralama",noData:"HenÃ¼z veri yok.",
    mostSleep:"En fazla uyku ðŸ˜´",bestEnergy:"En iyi enerji âš¡",leastScreen:"En az ekran ðŸ“µ",mostConsistent:"En tutarlÄ± ðŸ“…",
    collectiveCharts:"ðŸ‘¥ Toplu grafikler",need2students:"En az 2 Ã¶ÄŸrenci verisi gerekli.",
    allStudents:"ðŸ“‹ TÃ¼m Ã¶ÄŸrenciler",noStudents:"KayÄ±tlÄ± Ã¶ÄŸrenci yok.",noEntriesYet:"KayÄ±t yok.",
    hAvg:"s ort.",avg10:"/10 ort.",logs:"kayÄ±t",resetBtn:"ðŸ”‘ SÄ±fÄ±rla",
    iB7a:"âš ï¸ Ortalama uyku sÃ¼reniz ",iB7b:"s â€” Ã¶nerilen 7â€“9 saatin altÄ±nda.",
    iA7a:"âœ… Harika! Ortalama uyku sÃ¼reniz ",iA7b:"s saÄŸlÄ±klÄ± aralÄ±kta.",
    iSca:"ðŸ’¡ â‰¤1s ekran sÃ¼reli gÃ¼nlerde enerjiniz ",iScb:" puan daha yÃ¼ksekti!",
    iHSa:"ðŸ“± Uyku Ã¶ncesi ortalama ",iHSb:"s ekran sÃ¼resi var. AzaltmayÄ± deneyin.",
    iHEa:"âš¡ Sabah enerjisi gÃ¼Ã§lÃ¼ (ort. ",iHEb:"/10). BÃ¶yle devam!",
    iLEa:"ðŸ˜´ Sabah enerjisi dÃ¼ÅŸÃ¼k (ort. ",iLEb:"/10). Daha iyi alÄ±ÅŸkanlÄ±klar yardÄ±mcÄ± olabilir.",
    secQ0:"Ä°lk evcil hayvanÄ±nÄ±zÄ±n adÄ± neydi?",secQ1:"Annenizin kÄ±zlÄ±k soyadÄ± nedir?",
    secQ2:"Hangi ÅŸehirde doÄŸdunuz?",secQ3:"Ä°lkÃ¶ÄŸretim okulunuzun adÄ± neydi?",secQ4:"En sevdiÄŸiniz kitap nedir?",
    t0t:"Ekran sÃ¼resini sÄ±nÄ±rlayÄ±n",t0d:"Yatmadan en az 1 saat Ã¶nce ekranlardan uzak durun. Mavi Ä±ÅŸÄ±k melatonin Ã¼retimini baskÄ±lar.",
    t1t:"TutarlÄ± program",t1d:"Her gÃ¼n, hafta sonlarÄ± da dahil olmak Ã¼zere aynÄ± saatte yatÄ±p kalkÄ±n.",
    t2t:"OdanÄ±zÄ± serin tutun",t2d:"Optimum uyku kalitesi iÃ§in yatak odanÄ±zÄ± 16â€“20Â°C arasÄ±nda tutun.",
    t3t:"Kafeinden kaÃ§Ä±nÄ±n",t3d:"Ã–ÄŸleden sonra 14:00'den sonra kafein almayÄ±n. VÃ¼cudunuzda 6 saate kadar kalabilir.",
    t4t:"SakinleÅŸin",t4d:"Beyninize uyku sinyali vermek iÃ§in yatmadan Ã¶nce okuma, esneme veya meditasyon yapmayÄ± deneyin.",
    t5t:"KaranlÄ±k Ã¶nemlidir",t5d:"Karartma perdesi veya uyku maskesi kullanÄ±n. KÃ¼Ã§Ã¼k miktarda Ä±ÅŸÄ±k bile uykuyu bozabilir.",
    answerHint:"Cevap (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf duyarsÄ±z)",usernamePh:"kullanÄ±cÄ± adÄ±nÄ±z",developed:"Desenvolvido por: JosÃ© Paulo Tavares",
  }
};

/* â”€â”€ Language Context â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LangCtx = React.createContext({ lang:"en", t: k => k });

/* â”€â”€ LanguageSelector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function LanguageSelector({ lang, setLang }) {
  const [open, setOpen] = useState(false);
  const ref = useRef(null);
  const E = React.createElement;
  const cur = LANGUAGES.find(l => l.code === lang) || LANGUAGES[0];

  useEffect(() => {
    const h = e => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); };
    document.addEventListener("mousedown", h);
    return () => document.removeEventListener("mousedown", h);
  }, []);

  return E("div", { className:"lang-selector", ref },
    E("button", { className:"lang-btn", onClick:()=>setOpen(o=>!o) },
      E("span", { className:"lang-flag" }, cur.flag),
      E("span", null, cur.label),
      E("span", { className:"lang-caret" }, open?"â–²":"â–¼")
    ),
    open && E("div", { className:"lang-dropdown" },
      LANGUAGES.map(l => E("button", {
        key:l.code, className:"lang-option"+(l.code===lang?" selected":""),
        onClick:()=>{ setLang(l.code); setOpen(false); }
      },
        E("span",{className:"lo-flag"}, l.flag),
        E("span",null, l.label)
      ))
    )
  );
}

/* â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const API = async (method, path, body, token) => {
  const res = await fetch("/api" + path, {
    method,
    headers: { "Content-Type":"application/json", ...(token?{Authorization:"Bearer "+token}:{}) },
    body: body ? JSON.stringify(body) : undefined,
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || "Request failed");
  return data;
};

/* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const fmt = d => new Date(d).toLocaleDateString("en-GB",{weekday:"short",day:"2-digit",month:"short"});
const timeToH = t => { const [h,m]=t.split(":").map(Number); return h+m/60; };
const calcDur = (bed,wake) => { let b=timeToH(bed),w=timeToH(wake); if(w<=b)w+=24; return Math.round((w-b)*10)/10; };
const avg = arr => arr.length ? +(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1) : 0;

const genInsights = (entries, t) => {
  if (entries.length < 2) return [t("log2insights")];
  const msgs=[], as=avg(entries.map(e=>e.duration)), ae=avg(entries.map(e=>e.energy)), asc=avg(entries.map(e=>e.screen_time));
  msgs.push(as<7 ? t("iB7a")+as+t("iB7b") : t("iA7a")+as+t("iA7b"));
  const low=entries.filter(e=>e.screen_time<=1), high=entries.filter(e=>e.screen_time>1);
  if(low.length&&high.length){const eL=avg(low.map(e=>e.energy)),eH=avg(high.map(e=>e.energy)); if(eL>eH)msgs.push(t("iSca")+(eL-eH).toFixed(1)+t("iScb"));}
  if(asc>2)msgs.push(t("iHSa")+asc+t("iHSb"));
  if(ae>=7)msgs.push(t("iHEa")+ae+t("iHEb")); else if(ae<5)msgs.push(t("iLEa")+ae+t("iLEb"));
  return msgs;
};

/* â”€â”€ AuthScreen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function AuthScreen({ onLogin, lang, setLang }) {
  const { t } = React.useContext(LangCtx);
  const [mode,setMode]=useState("login");
  const [form,setForm]=useState({username:"",password:"",confirm:"",secQ:0,secA:""});
  const [rec,setRec]=useState({step:1,username:"",question:"",answer:"",newPass:"",confirm:""});
  const [err,setErr]=useState(""); const [ok,setOk]=useState(""); const [loading,setLoading]=useState(false);
  const sf=(k,v)=>setForm(f=>({...f,[k]:v}));
  const sr=(k,v)=>setRec(r=>({...r,[k]:v}));
  const SECQ=[t("secQ0"),t("secQ1"),t("secQ2"),t("secQ3"),t("secQ4")];

  const handleAuth = async () => {
    setErr(""); setOk(""); setLoading(true);
    try {
      const u=form.username.trim().toLowerCase(), p=form.password;
      if(!u||!p) throw new Error(t("fillAllFields"));
      if(mode==="register"&&p!==form.confirm) throw new Error(t("passwordsDontMatch"));
      if(mode==="register"&&!form.secA.trim()) throw new Error(t("provideSecAnswer"));
      const body=mode==="login"?{username:u,password:p}:{username:u,password:p,secQ:+form.secQ,secA:form.secA.trim()};
      const data=await API("POST",mode==="login"?"/login":"/register",body);
      localStorage.setItem("sd_token",data.token);
      localStorage.setItem("sd_user",JSON.stringify({username:data.username,isAdmin:data.isAdmin}));
      onLogin({username:data.username,isAdmin:data.isAdmin,token:data.token});
    } catch(e){setErr(e.message);} finally{setLoading(false);}
  };

  const handleRecover = async () => {
    setErr(""); setOk(""); setLoading(true);
    try {
      if(rec.step===1){
        if(!rec.username.trim()) throw new Error(t("enterUsername"));
        const data=await API("POST","/recover/question",{username:rec.username.trim()});
        setRec(r=>({...r,step:2,question:data.question}));
      } else if(rec.step===2){
        if(!rec.answer.trim()) throw new Error(t("enterAnswer"));
        setRec(r=>({...r,step:3}));
      } else {
        if(rec.newPass.length<4) throw new Error(t("minChars"));
        if(rec.newPass!==rec.confirm) throw new Error(t("passwordsDontMatch"));
        await API("POST","/recover/verify",{username:rec.username.trim(),answer:rec.answer.trim(),newPassword:rec.newPass});
        setOk(t("passwordResetLogin"));
        setTimeout(()=>{setMode("login");setErr("");setOk("");setRec({step:1,username:"",question:"",answer:"",newPass:"",confirm:""});},2000);
      }
    } catch(e){setErr(e.message);} finally{setLoading(false);}
  };

  const E=React.createElement;
  return E("div",{style:{minHeight:"100vh",background:"#0f172a",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"16px"}},
    E("div",{style:{position:"fixed",top:"12px",right:"16px",zIndex:1000}},
      E(LanguageSelector,{lang,setLang})
    ),
    E("div",{style:{fontSize:"3rem",marginBottom:"8px"}},"ðŸŒ™"),
    E("h1",{style:{fontSize:"1.6rem",fontWeight:700,color:"#fff",marginBottom:"4px"}},t("appTitle")),
    E("p",{style:{color:"#94a3b8",fontSize:"0.95rem",marginBottom:"24px"}},t("appSubtitle")),
    E("div",{className:"card",style:{width:"100%",maxWidth:"400px"}},
      mode!=="recover"&&E("div",{style:{display:"flex",borderRadius:"8px",overflow:"hidden",border:"1px solid #475569",marginBottom:"18px"}},
        ["login","register"].map(m=>E("button",{key:m,onClick:()=>{setMode(m);setErr("");setOk("");},
          style:{flex:1,padding:"10px",fontSize:"1rem",fontWeight:600,background:mode===m?"#4f46e5":"none",color:mode===m?"#fff":"#94a3b8",border:"none",cursor:"pointer"}},
          m==="login"?t("login"):t("register")))
      ),
      mode!=="recover"&&E(React.Fragment,null,
        E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("username")),E("input",{className:"inp",placeholder:t("usernamePh"),value:form.username,onChange:e=>sf("username",e.target.value)})),
        E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("password")),E("input",{type:"password",className:"inp",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢",value:form.password,onChange:e=>sf("password",e.target.value)})),
        mode==="register"&&E(React.Fragment,null,
          E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("confirmPassword")),E("input",{type:"password",className:"inp",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢",value:form.confirm,onChange:e=>sf("confirm",e.target.value)})),
          E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("securityQuestion")),
            E("select",{className:"sel",value:form.secQ,onChange:e=>sf("secQ",e.target.value)},
              SECQ.map((q,i)=>E("option",{key:i,value:i},q)))
          ),
          E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("yourAnswer")),E("input",{className:"inp",placeholder:t("answerHint"),value:form.secA,onChange:e=>sf("secA",e.target.value)}))
        ),
        err&&E("p",{style:{color:"#f87171",fontSize:"0.9rem",textAlign:"center",marginBottom:"10px"}},err),
        ok&&E("p",{style:{color:"#4ade80",fontSize:"0.9rem",textAlign:"center",marginBottom:"10px"}},ok),
        E("button",{className:"btn-primary",onClick:handleAuth,disabled:loading},loading?t("loading"):mode==="login"?t("loginBtn"):t("createAccountBtn")),
        mode==="login"&&E("div",{style:{textAlign:"center",marginTop:"10px"}},
          E("button",{onClick:()=>{setMode("recover");setErr("");setOk("");},style:{color:"#818cf8",fontSize:"0.9rem",textDecoration:"underline",background:"none",border:"none",cursor:"pointer"}},t("forgotPassword")))
      ),
      mode==="recover"&&E(React.Fragment,null,
        E("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"10px"}},
          E("button",{onClick:()=>{setMode("login");setErr("");setOk("");},style:{background:"none",border:"none",color:"#94a3b8",cursor:"pointer",fontSize:"1.3rem"}},"â†"),
          E("span",{style:{color:"#fff",fontWeight:600,fontSize:"1rem"}},t("passwordRecovery"))
        ),
        E("div",{style:{display:"flex",gap:"4px",marginBottom:"14px"}},
          [1,2,3].map(s=>E("div",{key:s,style:{flex:1,height:"4px",borderRadius:"9999px",background:rec.step>=s?"#6366f1":"#334155"}}))
        ),
        rec.step===1&&E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("username")),E("input",{className:"inp",placeholder:t("usernamePh"),value:rec.username,onChange:e=>sr("username",e.target.value)})),
        rec.step===2&&E(React.Fragment,null,
          E("div",{style:{background:"#334155",borderRadius:"8px",padding:"12px",marginBottom:"14px"}},E("p",{style:{color:"#e2e8f0",fontSize:"0.9rem",fontWeight:500}},rec.question)),
          E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("yourAnswer")),E("input",{className:"inp",placeholder:t("answerHint"),value:rec.answer,onChange:e=>sr("answer",e.target.value)}))
        ),
        rec.step===3&&E(React.Fragment,null,
          E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("newPassword")),E("input",{type:"password",className:"inp",placeholder:t("minChars"),value:rec.newPass,onChange:e=>sr("newPass",e.target.value)})),
          E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("confirmPassword")),E("input",{type:"password",className:"inp",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢",value:rec.confirm,onChange:e=>sr("confirm",e.target.value)}))
        ),
        err&&E("p",{style:{color:"#f87171",fontSize:"0.9rem",textAlign:"center",marginBottom:"10px"}},err),
        ok&&E("p",{style:{color:"#4ade80",fontSize:"0.9rem",textAlign:"center",marginBottom:"10px"}},ok),
        E("button",{className:"btn-primary",onClick:handleRecover,disabled:loading},loading?t("loading"):rec.step===3?t("resetPassword")+" âœ“":t("next"))
      )
    ),
    E("div",{className:"footer"},t("developed"))
  );
}

/* â”€â”€ ChangePasswordModal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function ChangePasswordModal({ token, onClose }) {
  const { t }=React.useContext(LangCtx);
  const [form,setForm]=useState({current:"",newPass:"",confirm:""});
  const [err,setErr]=useState(""); const [ok,setOk]=useState(""); const [loading,setLoading]=useState(false);
  const E=React.createElement;
  const handle=async()=>{
    setErr("");setOk("");setLoading(true);
    try{
      if(!form.current||!form.newPass||!form.confirm) throw new Error(t("fillAllFields"));
      if(form.newPass.length<4) throw new Error(t("minChars"));
      if(form.newPass!==form.confirm) throw new Error(t("passwordsDontMatch"));
      await API("POST","/change-password",{currentPassword:form.current,newPassword:form.newPass},token);
      setOk(t("passwordChanged")); setTimeout(onClose,1500);
    }catch(e){setErr(e.message);}finally{setLoading(false);}
  };
  return E("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.65)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:50,padding:"16px"}},
    E("div",{className:"card",style:{width:"100%",maxWidth:"400px"}},
      E("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"18px"}},
        E("span",{style:{color:"#fff",fontWeight:700,fontSize:"1.05rem"}},"ðŸ”‘ "+t("saveChanges").replace("Guardar ","").replace("Guardar","").replace("A guardar","").replace("Spremi","").replace("DeÄŸiÅŸiklikleri kaydet","").replace("Save","")+" Password"),
        E("button",{onClick:onClose,style:{background:"none",border:"none",color:"#94a3b8",cursor:"pointer",fontSize:"1.5rem"}},"Ã—")
      ),
      E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("currentPassword")),E("input",{type:"password",className:"inp",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢",value:form.current,onChange:e=>setForm(f=>({...f,current:e.target.value}))})),
      E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("newPassword")),E("input",{type:"password",className:"inp",placeholder:t("minChars"),value:form.newPass,onChange:e=>setForm(f=>({...f,newPass:e.target.value}))})),
      E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("confirmNewPassword")),E("input",{type:"password",className:"inp",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢",value:form.confirm,onChange:e=>setForm(f=>({...f,confirm:e.target.value}))})),
      err&&E("p",{style:{color:"#f87171",fontSize:"0.9rem",textAlign:"center",marginBottom:"10px"}},err),
      ok&&E("p",{style:{color:"#4ade80",fontSize:"0.9rem",textAlign:"center",marginBottom:"10px"}},ok),
      E("button",{className:"btn-primary",onClick:handle,disabled:loading},loading?t("saving"):t("saveChanges"))
    )
  );
}

/* â”€â”€ AdminResetModal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function AdminResetModal({ username, token, onClose }) {
  const { t }=React.useContext(LangCtx);
  const [form,setForm]=useState({newPass:"",confirm:""});
  const [err,setErr]=useState(""); const [ok,setOk]=useState(""); const [loading,setLoading]=useState(false);
  const E=React.createElement;
  const handle=async()=>{
    setErr("");setOk("");setLoading(true);
    try{
      if(form.newPass.length<4) throw new Error(t("minChars"));
      if(form.newPass!==form.confirm) throw new Error(t("passwordsDontMatch"));
      await API("POST","/admin/reset-password",{username,newPassword:form.newPass},token);
      setOk(t("passwordReset")); setTimeout(onClose,1500);
    }catch(e){setErr(e.message);}finally{setLoading(false);}
  };
  return E("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.65)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:50,padding:"16px"}},
    E("div",{className:"card",style:{width:"100%",maxWidth:"400px"}},
      E("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"18px"}},
        E("span",{style:{color:"#fff",fontWeight:700,fontSize:"1.05rem"}},"ðŸ”‘ "+t("resetPassword")+" â€” @"+username),
        E("button",{onClick:onClose,style:{background:"none",border:"none",color:"#94a3b8",cursor:"pointer",fontSize:"1.5rem"}},"Ã—")
      ),
      E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("newPassword")),E("input",{type:"password",className:"inp",placeholder:t("minChars"),value:form.newPass,onChange:e=>setForm(f=>({...f,newPass:e.target.value}))})),
      E("div",{style:{marginBottom:"14px"}},E("label",{className:"lbl"},t("confirmPassword")),E("input",{type:"password",className:"inp",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢",value:form.confirm,onChange:e=>setForm(f=>({...f,confirm:e.target.value}))})),
      err&&E("p",{style:{color:"#f87171",fontSize:"0.9rem",textAlign:"center",marginBottom:"10px"}},err),
      ok&&E("p",{style:{color:"#4ade80",fontSize:"0.9rem",textAlign:"center",marginBottom:"10px"}},ok),
      E("button",{onClick:handle,disabled:loading,style:{width:"100%",padding:"12px",borderRadius:"12px",fontWeight:700,color:"#fff",border:"none",cursor:"pointer",fontSize:"1rem",background:"linear-gradient(to right,#dc2626,#ea580c)"}},
        loading?t("resetting"):t("resetPassword"))
    )
  );
}

/* â”€â”€ StudentApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function StudentApp({ user, lang, setLang }) {
  const { t }=React.useContext(LangCtx);
  const [entries,setEntries]=useState([]);
  const [tab,setTab]=useState("log");
  const [form,setForm]=useState({date:new Date().toISOString().split("T")[0],bedTime:"23:00",wakeTime:"07:00",screenTime:1,energy:7,notes:""});
  const [saved,setSaved]=useState(false);
  const [showPw,setShowPw]=useState(false);
  const [loading,setLoading]=useState(true);
  const E=React.createElement;

  const TIPS=[
    {icon:"ðŸ“µ",title:t("t0t"),text:t("t0d")},{icon:"â°",title:t("t1t"),text:t("t1d")},
    {icon:"ðŸŒ¡ï¸",title:t("t2t"),text:t("t2d")},{icon:"â˜•",title:t("t3t"),text:t("t3d")},
    {icon:"ðŸ§˜",title:t("t4t"),text:t("t4d")},{icon:"ðŸŒ™",title:t("t5t"),text:t("t5d")},
  ];

  const loadEntries=useCallback(async()=>{
    try{const data=await API("GET","/entries",null,user.token);setEntries(data);}catch(e){console.error(e);}
    setLoading(false);
  },[user.token]);
  useEffect(()=>{loadEntries();},[loadEntries]);

  const handleSave=async()=>{
    const duration=calcDur(form.bedTime,form.wakeTime);
    try{await API("POST","/entries",{...form,duration},user.token);setSaved(true);setTimeout(()=>setSaved(false),2000);loadEntries();}
    catch(e){alert(e.message);}
  };
  const del=async id=>{try{await API("DELETE","/entries/"+id,null,user.token);loadEntries();}catch(e){alert(e.message);}};

  const weekly=entries.slice(0,7).reverse();
  const chartData=weekly.map(e=>({name:fmt(e.date),Sleep:e.duration,Screen:e.screen_time,Energy:e.energy}));
  const TABS=[["log",t("tabLog")],["history",t("tabHistory")],["charts",t("tabCharts")],["insights",t("tabInsights")],["tips",t("tabTips")]];

  return E("div",{style:{minHeight:"100vh",background:"#0f172a"}},
    showPw&&E(ChangePasswordModal,{token:user.token,onClose:()=>setShowPw(false)}),
    E("div",{className:"grad-header",style:{padding:"14px 16px",display:"flex",alignItems:"center",justifyContent:"space-between"}},
      E("div",null,
        E("div",{style:{fontSize:"1.15rem",fontWeight:700,color:"#fff"}},"ðŸŒ™ "+t("appTitle")),
        E("div",{style:{color:"#94a3b8",fontSize:"0.85rem"}},"@"+user.username)
      ),
      E("div",{style:{display:"flex",gap:"8px",alignItems:"center"}},
        E(LanguageSelector,{lang,setLang}),
        E("button",{className:"btn-outline",onClick:()=>setShowPw(true)},t("changePw")),
        E("button",{className:"btn-outline",onClick:user.logout},t("logout"))
      )
    ),
    E("div",{style:{display:"flex",borderBottom:"2px solid #1e293b",background:"#0a0f1e",overflowX:"auto"}},
      TABS.map(([k,l])=>E("button",{key:k,className:"tab-btn"+(tab===k?" active":""),onClick:()=>setTab(k)},l))
    ),
    E("div",{style:{padding:"16px 16px 8px",maxWidth:"672px",margin:"0 auto"}},
      loading&&E("div",{className:"spinner"}),
      !loading&&E(React.Fragment,null,

        tab==="log"&&E("div",{className:"space-y-4"},
          E("h2",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1.1rem"}},t("todayLog")),
          E("div",null,E("label",{className:"lbl"},t("date")),E("input",{type:"date",className:"inp",value:form.date,onChange:e=>setForm({...form,date:e.target.value})})),
          E("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px"}},
            E("div",null,E("label",{className:"lbl"},t("bedtime")),E("input",{type:"time",className:"inp",value:form.bedTime,onChange:e=>setForm({...form,bedTime:e.target.value})})),
            E("div",null,E("label",{className:"lbl"},t("wakeUp")),E("input",{type:"time",className:"inp",value:form.wakeTime,onChange:e=>setForm({...form,wakeTime:e.target.value})}))
          ),
          E("div",{style:{background:"#1e293b",borderRadius:"8px",padding:"12px",textAlign:"center"}},
            E("span",{style:{color:"#94a3b8",fontSize:"0.95rem"}},t("duration")),
            E("span",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1.3rem"}},calcDur(form.bedTime,form.wakeTime)+"h")
          ),
          E("div",null,
            E("label",{className:"lbl"},t("screenTime"),E("span",{style:{color:"#a5b4fc",fontWeight:700}},form.screenTime+"h")),
            E("input",{type:"range",min:0,max:6,step:0.5,value:form.screenTime,className:"accent-indigo",onChange:e=>setForm({...form,screenTime:+e.target.value})}),
            E("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.85rem",color:"#94a3b8",marginTop:"4px"}},E("span",null,"0h"),E("span",null,"3h"),E("span",null,"6h"))
          ),
          E("div",null,
            E("label",{className:"lbl"},t("morningEnergy"),E("span",{style:{color:"#facc15",fontWeight:700}},form.energy+"/10")),
            E("input",{type:"range",min:1,max:10,step:1,value:form.energy,className:"accent-yellow",onChange:e=>setForm({...form,energy:+e.target.value})}),
            E("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.85rem",color:"#94a3b8",marginTop:"4px"}},E("span",null,"ðŸ˜´ 1"),E("span",null,"ðŸ˜ 5"),E("span",null,"âš¡ 10"))
          ),
          E("div",null,E("label",{className:"lbl"},t("notes")),E("textarea",{className:"inp",placeholder:t("notesPlaceholder"),value:form.notes,onChange:e=>setForm({...form,notes:e.target.value}),style:{resize:"none",height:"72px"}})),
          E("button",{className:"btn-primary",onClick:handleSave},saved?t("saved"):t("saveEntry"))
        ),

        tab==="history"&&E("div",{className:"space-y-3"},
          E("h2",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1.1rem"}},t("weeklyHistory")),
          entries.length===0&&E("p",{style:{color:"#94a3b8",textAlign:"center",padding:"32px 0",fontSize:"0.95rem"}},t("noEntries")),
          entries.slice(0,7).map(e=>E("div",{key:e.id,className:"card"},
            E("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}},
              E("div",null,
                E("p",{style:{fontWeight:700,color:"#f1f5f9",fontSize:"1rem"}},fmt(e.date)),
                E("p",{style:{color:"#94a3b8",fontSize:"0.85rem",marginTop:"2px"}},e.bed_time+" â†’ "+e.wake_time)
              ),
              E("button",{onClick:()=>del(e.id),style:{background:"none",border:"none",color:"#475569",cursor:"pointer",fontSize:"1.1rem"}},"ðŸ—‘")
            ),
            E("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"8px",marginTop:"12px"}},
              E("div",{className:"mini-card"},E("div",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1rem"}},e.duration+"h"),E("div",{style:{color:"#94a3b8",fontSize:"0.8rem"}},t("sleep"))),
              E("div",{className:"mini-card"},E("div",{style:{color:"#d8b4fe",fontWeight:700,fontSize:"1rem"}},e.screen_time+"h"),E("div",{style:{color:"#94a3b8",fontSize:"0.8rem"}},t("screen"))),
              E("div",{className:"mini-card"},E("div",{style:{color:"#fde047",fontWeight:700,fontSize:"1rem"}},e.energy+"/10"),E("div",{style:{color:"#94a3b8",fontSize:"0.8rem"}},t("energy")))
            ),
            e.notes&&E("p",{style:{color:"#94a3b8",fontSize:"0.85rem",marginTop:"8px",fontStyle:"italic"}},'"'+e.notes+'"')
          ))
        ),

        tab==="charts"&&E("div",{className:"space-y-5"},
          E("h2",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1.1rem"}},t("weeklyCharts")),
          chartData.length<2&&E("p",{style:{color:"#94a3b8",textAlign:"center",padding:"32px 0",fontSize:"0.95rem"}},t("log2days")),
          chartData.length>=2&&E(React.Fragment,null,
            E("div",{className:"card"},
              E("h3",{style:{color:"#e2e8f0",fontSize:"0.95rem",fontWeight:600,marginBottom:"12px"}},t("sleepDuration")),
              E(ResponsiveContainer,{width:"100%",height:160},
                E(BarChart,{data:chartData},
                  E(CartesianGrid,{strokeDasharray:"3 3",stroke:"#334155"}),
                  E(XAxis,{dataKey:"name",tick:{fill:"#94a3b8",fontSize:11}}),
                  E(YAxis,{tick:{fill:"#94a3b8",fontSize:11},domain:[0,12]}),
                  E(Tooltip,{contentStyle:{background:"#1e293b",border:"none",borderRadius:8,fontSize:12}}),
                  E(Bar,{dataKey:"Sleep",fill:"#6366f1",radius:[4,4,0,0]})
                )
              )
            ),
            E("div",{className:"card"},
              E("h3",{style:{color:"#e2e8f0",fontSize:"0.95rem",fontWeight:600,marginBottom:"12px"}},t("screenVsEnergy")),
              E(ResponsiveContainer,{width:"100%",height:160},
                E(LineChart,{data:chartData},
                  E(CartesianGrid,{strokeDasharray:"3 3",stroke:"#334155"}),
                  E(XAxis,{dataKey:"name",tick:{fill:"#94a3b8",fontSize:11}}),
                  E(YAxis,{tick:{fill:"#94a3b8",fontSize:11}}),
                  E(Tooltip,{contentStyle:{background:"#1e293b",border:"none",borderRadius:8,fontSize:12}}),
                  E(Legend,{wrapperStyle:{fontSize:12}}),
                  E(Line,{type:"monotone",dataKey:"Screen",stroke:"#a78bfa",strokeWidth:2,dot:{r:3},name:t("screen")+" (h)"}),
                  E(Line,{type:"monotone",dataKey:"Energy",stroke:"#fbbf24",strokeWidth:2,dot:{r:3},name:t("energy")+" (/10)"})
                )
              )
            )
          )
        ),

        tab==="insights"&&E("div",{className:"space-y-3"},
          E("h2",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1.1rem"}},t("autoInsights")),
          genInsights(entries,t).map((msg,i)=>E("div",{key:i,className:"card"},E("p",{style:{color:"#e2e8f0",fontSize:"0.95rem",lineHeight:1.65}},msg)))
        ),

        tab==="tips"&&E("div",{className:"space-y-3"},
          E("h2",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1.1rem"}},t("sleepHygiene")),
          TIPS.map((tip,i)=>E("div",{key:i,className:"card",style:{display:"flex",gap:"12px"}},
            E("span",{style:{fontSize:"1.6rem"}},tip.icon),
            E("div",null,
              E("h3",{style:{color:"#f1f5f9",fontWeight:700,fontSize:"0.95rem"}},tip.title),
              E("p",{style:{color:"#94a3b8",fontSize:"0.88rem",marginTop:"4px",lineHeight:1.6}},tip.text)
            )
          ))
        )
      )
    ),
    E("div",{className:"footer"},t("developed"))
  );
}

/* â”€â”€ AdminApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function AdminApp({ user, lang, setLang }) {
  const { t }=React.useContext(LangCtx);
  const [data,setData]=useState([]);
  const [tab,setTab]=useState("overview");
  const [loading,setLoading]=useState(true);
  const [resetUser,setResetUser]=useState(null);
  const E=React.createElement;

  const loadData=useCallback(async()=>{
    setLoading(true);
    try{const d=await API("GET","/admin/users",null,user.token);setData(d);}catch(e){console.error(e);}
    setLoading(false);
  },[user.token]);
  useEffect(()=>{loadData();},[loadData]);

  const allEntries=data.flatMap(u=>u.entries);
  const rankings=data.filter(u=>u.entries.length>0).map(u=>({
    name:u.username,
    avgSleep:avg(u.entries.map(e=>e.duration)),
    avgEnergy:avg(u.entries.map(e=>e.energy)),
    avgScreen:avg(u.entries.map(e=>e.screen_time)),
    count:u.entries.length,
  }));
  const groupChart=rankings.map(r=>({name:r.name,Sleep:r.avgSleep,Energy:r.avgEnergy,Screen:r.avgScreen}));
  const medal=i=>["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][i]||(i+1)+".";
  const TABS=[["overview",t("tabOverview")],["rankings",t("tabRankings")],["compare",t("tabCompare")],["students",t("tabStudents")]];

  return E("div",{style:{minHeight:"100vh",background:"#0f172a"}},
    resetUser&&E(AdminResetModal,{username:resetUser,token:user.token,onClose:()=>{setResetUser(null);loadData();}}),
    E("div",{className:"grad-admin",style:{padding:"14px 16px",display:"flex",alignItems:"center",justifyContent:"space-between"}},
      E("div",null,
        E("div",{style:{fontSize:"1.15rem",fontWeight:700,color:"#fff"}},t("adminPanel")),
        E("div",{style:{color:"#94a3b8",fontSize:"0.85rem"}},data.length+t("studentsReg"))
      ),
      E("div",{style:{display:"flex",gap:"8px",alignItems:"center"}},
        E(LanguageSelector,{lang,setLang}),
        E("button",{className:"btn-outline",onClick:user.logout},t("logout"))
      )
    ),
    E("div",{style:{display:"flex",borderBottom:"2px solid #1e293b",background:"#0a0f1e",overflowX:"auto"}},
      TABS.map(([k,l])=>E("button",{key:k,className:"tab-btn"+(tab===k?" active":""),onClick:()=>setTab(k)},l))
    ),
    E("div",{style:{padding:"16px 16px 8px",maxWidth:"672px",margin:"0 auto"}},
      loading&&E("div",{className:"spinner"}),
      !loading&&E(React.Fragment,null,

        tab==="overview"&&E("div",{className:"space-y-4"},
          E("h2",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1.1rem"}},t("groupOverview")),
          allEntries.length===0&&E("p",{style:{color:"#94a3b8",textAlign:"center",padding:"32px 0",fontSize:"0.95rem"}},t("noStudentData")),
          allEntries.length>0&&E(React.Fragment,null,
            E("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px"}},
              [
                {label:t("avgSleep"),val:avg(allEntries.map(e=>e.duration))+"h",icon:"ðŸ›ï¸",color:"#a5b4fc"},
                {label:t("avgEnergy"),val:avg(allEntries.map(e=>e.energy))+"/10",icon:"âš¡",color:"#facc15"},
                {label:t("avgScreen"),val:avg(allEntries.map(e=>e.screen_time))+"h",icon:"ðŸ“±",color:"#d8b4fe"},
                {label:t("totalLogs"),val:allEntries.length,icon:"ðŸ“",color:"#86efac"},
              ].map((s,i)=>E("div",{key:i,className:"stat-card"},
                E("div",{style:{fontSize:"1.6rem",marginBottom:"4px"}},s.icon),
                E("div",{style:{fontSize:"1.3rem",fontWeight:700,color:s.color}},s.val),
                E("div",{style:{color:"#94a3b8",fontSize:"0.85rem",marginTop:"4px"}},s.label)
              ))
            ),
            groupChart.length>=2&&E("div",{className:"card"},
              E("h3",{style:{color:"#e2e8f0",fontSize:"0.95rem",fontWeight:600,marginBottom:"12px"}},t("studentAverages")),
              E(ResponsiveContainer,{width:"100%",height:200},
                E(BarChart,{data:groupChart,layout:"vertical"},
                  E(CartesianGrid,{strokeDasharray:"3 3",stroke:"#334155"}),
                  E(XAxis,{type:"number",tick:{fill:"#94a3b8",fontSize:11}}),
                  E(YAxis,{type:"category",dataKey:"name",tick:{fill:"#94a3b8",fontSize:11},width:70}),
                  E(Tooltip,{contentStyle:{background:"#1e293b",border:"none",borderRadius:8,fontSize:12}}),
                  E(Legend,{wrapperStyle:{fontSize:12}}),
                  E(Bar,{dataKey:"Sleep",fill:"#6366f1",name:t("sleep")+" (h)",radius:[0,4,4,0]}),
                  E(Bar,{dataKey:"Energy",fill:"#fbbf24",name:t("energy")+" (/10)",radius:[0,4,4,0]}),
                  E(Bar,{dataKey:"Screen",fill:"#a78bfa",name:t("screen")+" (h)",radius:[0,4,4,0]})
                )
              )
            )
          )
        ),

        tab==="rankings"&&E("div",{className:"space-y-4"},
          E("h2",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1.1rem"}},t("rankings")),
          rankings.length===0&&E("p",{style:{color:"#94a3b8",textAlign:"center",padding:"32px 0",fontSize:"0.95rem"}},t("noData")),
          [
            {title:t("mostSleep"),key:"avgSleep",unit:t("hAvg"),sort:(a,b)=>b.avgSleep-a.avgSleep,color:"#a5b4fc"},
            {title:t("bestEnergy"),key:"avgEnergy",unit:t("avg10"),sort:(a,b)=>b.avgEnergy-a.avgEnergy,color:"#facc15"},
            {title:t("leastScreen"),key:"avgScreen",unit:t("hAvg"),sort:(a,b)=>a.avgScreen-b.avgScreen,color:"#d8b4fe"},
            {title:t("mostConsistent"),key:"count",unit:t("logs"),sort:(a,b)=>b.count-a.count,color:"#86efac"},
          ].map((r,ri)=>E("div",{key:ri,className:"card"},
            E("h3",{style:{color:"#f1f5f9",fontWeight:700,fontSize:"0.95rem",marginBottom:"12px"}},r.title),
            E("div",{className:"space-y-2"},
              [...rankings].sort(r.sort).slice(0,5).map((u,i)=>
                E("div",{key:u.name,style:{display:"flex",justifyContent:"space-between",alignItems:"center"}},
                  E("div",{style:{display:"flex",alignItems:"center",gap:"8px"}},
                    E("span",{style:{fontSize:"1.1rem"}},medal(i)),
                    E("span",{style:{color:"#e2e8f0",fontSize:"0.95rem"}},"@"+u.name)
                  ),
                  E("span",{style:{color:r.color,fontWeight:700,fontSize:"0.95rem"}},u[r.key]+" "+r.unit)
                )
              )
            )
          ))
        ),

        tab==="compare"&&E("div",{className:"space-y-4"},
          E("h2",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1.1rem"}},t("collectiveCharts")),
          groupChart.length<2&&E("p",{style:{color:"#94a3b8",textAlign:"center",padding:"32px 0",fontSize:"0.95rem"}},t("need2students")),
          groupChart.length>=2&&E(React.Fragment,null,
            E("div",{className:"card"},
              E("h3",{style:{color:"#e2e8f0",fontSize:"0.95rem",fontWeight:600,marginBottom:"12px"}},t("sleepPerStudent")),
              E(ResponsiveContainer,{width:"100%",height:180},
                E(BarChart,{data:groupChart},
                  E(CartesianGrid,{strokeDasharray:"3 3",stroke:"#334155"}),
                  E(XAxis,{dataKey:"name",tick:{fill:"#94a3b8",fontSize:11}}),
                  E(YAxis,{tick:{fill:"#94a3b8",fontSize:11},domain:[0,12]}),
                  E(Tooltip,{contentStyle:{background:"#1e293b",border:"none",borderRadius:8,fontSize:12}}),
                  E(Bar,{dataKey:"Sleep",fill:"#6366f1",radius:[4,4,0,0],name:t("avgSleep")+" (h)"})
                )
              )
            ),
            E("div",{className:"card"},
              E("h3",{style:{color:"#e2e8f0",fontSize:"0.95rem",fontWeight:600,marginBottom:"12px"}},t("energyVsScreen")),
              E(ResponsiveContainer,{width:"100%",height:180},
                E(BarChart,{data:groupChart},
                  E(CartesianGrid,{strokeDasharray:"3 3",stroke:"#334155"}),
                  E(XAxis,{dataKey:"name",tick:{fill:"#94a3b8",fontSize:11}}),
                  E(YAxis,{tick:{fill:"#94a3b8",fontSize:11}}),
                  E(Tooltip,{contentStyle:{background:"#1e293b",border:"none",borderRadius:8,fontSize:12}}),
                  E(Legend,{wrapperStyle:{fontSize:12}}),
                  E(Bar,{dataKey:"Energy",fill:"#fbbf24",radius:[4,4,0,0],name:t("energy")+" (/10)"}),
                  E(Bar,{dataKey:"Screen",fill:"#a78bfa",radius:[4,4,0,0],name:t("screen")+" (h)"})
                )
              )
            ),
            E("div",{className:"card"},
              E("h3",{style:{color:"#e2e8f0",fontSize:"0.95rem",fontWeight:600,marginBottom:"12px"}},t("radarProfiles")),
              E(ResponsiveContainer,{width:"100%",height:220},
                E(RadarChart,{data:groupChart},
                  E(PolarGrid,{stroke:"#334155"}),
                  E(PolarAngleAxis,{dataKey:"name",tick:{fill:"#94a3b8",fontSize:11}}),
                  E(Radar,{name:t("sleep"),dataKey:"Sleep",stroke:"#6366f1",fill:"#6366f1",fillOpacity:0.3}),
                  E(Radar,{name:t("energy"),dataKey:"Energy",stroke:"#fbbf24",fill:"#fbbf24",fillOpacity:0.3}),
                  E(Legend,{wrapperStyle:{fontSize:12}})
                )
              )
            )
          )
        ),

        tab==="students"&&E("div",{className:"space-y-3"},
          E("h2",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1.1rem"}},t("allStudents")),
          data.length===0&&E("p",{style:{color:"#94a3b8",textAlign:"center",padding:"32px 0",fontSize:"0.95rem"}},t("noStudents")),
          data.map(u=>E("div",{key:u.id,className:"card"},
            E("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}},
              E("span",{style:{color:"#f1f5f9",fontWeight:700,fontSize:"0.95rem"}},"@"+u.username),
              E("div",{style:{display:"flex",alignItems:"center",gap:"8px"}},
                E("span",{style:{color:"#94a3b8",fontSize:"0.85rem"}},u.entries.length+" "+t("logs")),
                E("button",{onClick:()=>setResetUser(u.username),style:{fontSize:"0.82rem",color:"#fb923c",border:"1px solid #9a3412",background:"none",borderRadius:"6px",padding:"4px 10px",cursor:"pointer"}},t("resetBtn"))
              )
            ),
            u.entries.length>0
              ?E("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"8px"}},
                  E("div",{className:"mini-card"},E("div",{style:{color:"#a5b4fc",fontWeight:700,fontSize:"1rem"}},avg(u.entries.map(e=>e.duration))+"h"),E("div",{style:{color:"#94a3b8",fontSize:"0.8rem"}},t("avgSleep"))),
                  E("div",{className:"mini-card"},E("div",{style:{color:"#facc15",fontWeight:700,fontSize:"1rem"}},avg(u.entries.map(e=>e.energy))+"/10"),E("div",{style:{color:"#94a3b8",fontSize:"0.8rem"}},t("avgEnergy"))),
                  E("div",{className:"mini-card"},E("div",{style:{color:"#d8b4fe",fontWeight:700,fontSize:"1rem"}},avg(u.entries.map(e=>e.screen_time))+"h"),E("div",{style:{color:"#94a3b8",fontSize:"0.8rem"}},t("avgScreen")))
                )
              :E("p",{style:{color:"#64748b",fontSize:"0.85rem"}},t("noEntriesYet"))
          ))
        )
      )
    ),
    E("div",{className:"footer"},t("developed"))
  );
}

/* â”€â”€ App Root â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function App() {
  const [user,setUser]=useState(()=>{
    const tk=localStorage.getItem("sd_token"), u=localStorage.getItem("sd_user");
    return tk&&u?{...JSON.parse(u),token:tk}:null;
  });
  const [lang,setLang]=useState(()=>localStorage.getItem("sd_lang")||"en");

  useEffect(()=>{ localStorage.setItem("sd_lang",lang); },[lang]);

  const t=key=>(T[lang]&&T[lang][key]!=null)?T[lang][key]:(T.en[key]||key);

  const logout=()=>{ localStorage.removeItem("sd_token"); localStorage.removeItem("sd_user"); setUser(null); };

  return React.createElement(LangCtx.Provider,{value:{lang,t}},
    user
      ?(user.isAdmin
          ?React.createElement(AdminApp,{user:{...user,logout},lang,setLang})
          :React.createElement(StudentApp,{user:{...user,logout},lang,setLang}))
      :React.createElement(AuthScreen,{onLogin:data=>setUser(data),lang,setLang})
  );
}

ReactDOM.render(React.createElement(App),document.getElementById("root"));
</script>
</body>
</html>
